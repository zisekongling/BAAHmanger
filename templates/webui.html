<!DOCTYPE html>
<html>
<head>
    <title>BAAH配置编辑器</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* 基础样式 */
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #45a049;
            --secondary-color: #2196F3;
            --secondary-dark: #1976D2;
            --danger-color: #f44336;
            --danger-dark: #d32f2f;
            --warning-color: #ff9800;
            --warning-dark: #f57c00;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --border-color: #dee2e6;
            --text-color: #333;
            --text-light: #6c757d;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        /* 头部样式 */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* 命令按钮区域 */
        .command-section {
            background: var(--light-bg);
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-title {
            font-size: 1.3rem;
            color: var(--text-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 1.5rem;
        }
        
        .command-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .command-btn {
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 60px;
        }
        
        .command-btn i {
            font-size: 1.2rem;
        }
        
        .command-btn.check {
            background-color: var(--primary-color);
            color: white;
        }
        
        .command-btn.monitor {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .command-btn.getdata {
            background-color: #9C27B0;
            color: white;
        }
        
        .command-btn.send {
            background-color: var(--warning-color);
            color: white;
        }
        
        .command-btn.writesuccess {
            background-color: #009688;
            color: white;
        }
        
        .command-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        .command-btn:active {
            transform: translateY(-1px);
        }
        
        .command-btn.loading {
            position: relative;
            color: transparent !important;
        }
        
        .command-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 状态提示 */
        .status-container {
            padding: 0 25px;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            animation: fadeIn 0.3s ease;
            align-items: center;
            gap: 12px;
        }
        
        .status i {
            font-size: 1.5rem;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 配置表单区域 */
        .config-section {
            padding: 30px;
        }
        
        .config-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }
        
        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .tab-btn:hover {
            background: var(--light-bg);
            color: var(--text-color);
        }
        
        .tab-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .config-group {
            background: var(--light-bg);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        
        .config-group h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            font-size: 1.4rem;
        }
        
        .field-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .field-group {
            display: flex;
            flex-direction: column;
        }
        
        .field-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .field-group label .field-tip {
            color: var(--text-light);
            font-size: 0.9rem;
            font-weight: normal;
        }
        
        .field-group input,
        .field-group select {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            transition: var(--transition);
        }
        
        .field-group input:focus,
        .field-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }
        
        .field-group input[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
        
        /* 操作按钮区域 */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: 30px;
            background: var(--light-bg);
            border-top: 1px solid var(--border-color);
        }
        
        .action-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
            justify-content: center;
        }
        
        .action-btn.save {
            background: var(--primary-color);
            color: white;
        }
        
        .action-btn.reset {
            background: var(--text-light);
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }
        
        .action-btn:active {
            transform: translateY(-1px);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
            }
            
            .command-buttons {
                grid-template-columns: 1fr;
            }
            
            .field-row {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
            }
        }
    </style>
    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-robot"></i> BAAH任务管理程序</h1>
            <p>自动化任务监控与报告生成系统</p>
        </div>
        
        <div class="command-section">
            <h2 class="section-title"><i class="fas fa-play-circle"></i> 快速执行命令</h2>
            <div class="command-buttons">
                <button class="command-btn check" onclick="runCommand('check')">
                    <i class="fas fa-search"></i> 检查任务
                </button>
                <button class="command-btn monitor" onclick="runCommand('monitor')">
                    <i class="fas fa-desktop"></i> 监控任务
                </button>
                <button class="command-btn getdata" onclick="runCommand('getdata')">
                    <i class="fas fa-envelope"></i> 获取数据
                </button>
                <button class="command-btn send" onclick="runCommand('send')">
                    <i class="fas fa-file-export"></i> 生成报告
                </button>
                <button class="command-btn writesuccess" onclick="runCommand('writesuccess')">
                    <i class="fas fa-check-circle"></i> 写入成功
                </button>
            </div>
        </div>
        
        <div class="status-container">
            <div id="status" class="status"></div>
        </div>
        
        <div class="config-section">
            <h2 class="section-title"><i class="fas fa-cog"></i> 系统配置</h2>
            
            <div class="config-tabs" id="configTabs">
                <!-- 选项卡将通过JavaScript动态生成 -->
            </div>
            
            <form id="configForm">
                <div id="tabContents">
                    <!-- 选项卡内容将通过JavaScript动态生成 -->
                </div>
                
                <div class="action-buttons">
                    <button type="submit" class="action-btn save">
                        <i class="fas fa-save"></i> 保存配置
                    </button>
                    <button type="button" class="action-btn reset" onclick="resetForm()">
                        <i class="fas fa-redo"></i> 重置表单
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // 配置数据
        let configData = {{CONFIG_DATA}};
        const chineseLabels = {{CHINESE_LABELS}};
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            initTabs();
            renderConfigForm();
            
            // 获取当前配置
            fetch('/config')
                .then(response => response.json())
                .then(data => {
                    configData = data;
                    renderConfigForm();
                })
                .catch(error => {
                    showStatus('获取配置失败: ' + error, false);
                });
        });
        
        // 初始化选项卡
        function initTabs() {
            const tabsContainer = document.getElementById('configTabs');
            const tabsContent = document.getElementById('tabContents');
            
            const tabNames = {
                'file_paths': '文件路径',
                'program_paths': '程序路径',
                'email': '邮箱设置',
                'process_names': '进程名称',
                'timing': '时间设置',
                'gitee': 'Gitee设置',
                'completion': '完成操作'
            };
            
            let firstTab = true;
            for (const [tabId, tabName] of Object.entries(tabNames)) {
                // 创建选项卡按钮
                const tabBtn = document.createElement('button');
                tabBtn.className = `tab-btn ${firstTab ? 'active' : ''}`;
                tabBtn.textContent = tabName;
                tabBtn.dataset.tab = tabId;
                tabBtn.onclick = function() {
                    switchTab(tabId);
                };
                tabsContainer.appendChild(tabBtn);
                
                // 创建选项卡内容
                const tabContent = document.createElement('div');
                tabContent.className = `tab-content ${firstTab ? 'active' : ''}`;
                tabContent.id = `tab-${tabId}`;
                tabsContent.appendChild(tabContent);
                
                firstTab = false;
            }
        }
        
        // 切换选项卡
        function switchTab(tabId) {
            // 移除所有激活状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 激活当前选项卡
            document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }
        
        // 渲染配置表单
        function renderConfigForm() {
            // 渲染各个选项卡内容
            renderTabContent('file_paths', '文件路径设置', '不建议修改');
            renderTabContent('program_paths', '程序路径设置', '请根据您的系统设置正确路径');
            renderTabContent('email', '邮箱设置', '用于接收BAAH完成邮件的邮箱配置');
            renderTabContent('process_names', '进程名称设置', '不建议修改');
            renderTabContent('timing', '时间设置', '各项任务的时间间隔配置');
            renderTabContent('gitee', 'Gitee设置', '用于上传报告的Gitee配置');
            renderCompletionTab();
        }
        
        // 渲染选项卡内容
        function renderTabContent(tabId, title, description) {
            const tabContent = document.getElementById(`tab-${tabId}`);
            const configSection = configData[tabId] || {};
            const labels = chineseLabels[tabId] || {};
            
            let html = `
                <div class="config-group">
                    <h3>${title} <span class="field-tip">${description}</span></h3>
                    <div class="field-row">
            `;
            
            for (const [key, value] of Object.entries(configSection)) {
                const label = labels[key] || key;
                const fieldId = `${tabId}.${key}`;
                const fieldValue = value === null ? '' : String(value);
                const isReadonly = tabId === 'file_paths' || tabId === 'process_names';
                
                html += `
                    <div class="field-group">
                        <label for="${fieldId}">
                            ${label}
                            ${isReadonly ? '<span class="field-tip">(只读)</span>' : ''}
                        </label>
                        <input type="text" 
                               id="${fieldId}" 
                               name="${fieldId}" 
                               value="${escapeHtml(fieldValue)}"
                               ${isReadonly ? 'readonly' : ''}>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            tabContent.innerHTML = html;
        }
        
        // 渲染完成操作选项卡
        function renderCompletionTab() {
            const tabContent = document.getElementById('tab-completion');
            const globalAction = configData.task_completion_action || 'none';
            const scheduledActions = configData.scheduled_completion_actions || [];
            
            const actions = [
                {value: 'none', label: '不执行任何操作', icon: 'fas fa-times-circle'},
                {value: 'logout', label: '注销系统', icon: 'fas fa-sign-out-alt'},
                {value: 'shutdown', label: '关闭计算机', icon: 'fas fa-power-off'},
                {value: 'restart', label: '重新启动', icon: 'fas fa-redo'}
            ];
            
            let html = `
                <div class="config-group">
                    <h3>全局默认操作 <span class="field-tip">当时间段未匹配时执行的操作</span></h3>
                    <div class="field-row">
            `;
            
            actions.forEach(actionItem => {
                html += `
                    <div class="field-group">
                        <label style="flex-direction: row; align-items: center;">
                            <input type="radio" 
                                   name="task_completion_action" 
                                   value="${actionItem.value}"
                                   ${globalAction === actionItem.value ? 'checked' : ''}
                                   style="margin-right: 10px;">
                            <i class="${actionItem.icon}" style="margin-right: 8px;"></i>
                            ${actionItem.label}
                        </label>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <div class="config-group">
                    <h3>时间段操作配置 <span class="field-tip">根据时间段执行不同的操作（支持跨午夜）</span></h3>
                    <div id="scheduledActionsContainer">
            `;
            
            // 渲染时间段配置
            if (scheduledActions.length === 0) {
                html += `
                    <div class="no-schedule" style="text-align: center; padding: 20px; color: #666;">
                        <i class="fas fa-clock fa-2x" style="margin-bottom: 10px;"></i>
                        <p>未配置时间段，将使用全局默认操作</p>
                        <button type="button" onclick="addNewSchedule()" class="action-btn save" style="margin-top: 10px;">
                            <i class="fas fa-plus"></i> 添加时间段
                        </button>
                    </div>
                `;
            } else {
                html += `
                    <div style="margin-bottom: 15px;">
                        <button type="button" onclick="addNewSchedule()" class="action-btn save" style="padding: 10px 15px;">
                            <i class="fas fa-plus"></i> 添加新时间段
                        </button>
                    </div>
                `;
                
                scheduledActions.forEach((schedule, index) => {
                    const name = schedule.name || `时间段${index + 1}`;
                    const startTime = schedule.start_time || '00:00';
                    const endTime = schedule.end_time || '23:59';
                    const action = schedule.action || 'none';
                    const enabled = schedule.enabled !== false;
                    
                    html += `
                        <div class="schedule-item" data-index="${index}" style="
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            padding: 15px;
                            margin-bottom: 15px;
                            background: ${enabled ? '#f8f9fa' : '#f0f0f0'};
                        ">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: #333;">
                                    ${enabled ? '✓' : '✗'} ${name}
                                </h4>
                                <div>
                                    <button type="button" onclick="toggleSchedule(${index})" style="
                                        background: ${enabled ? '#4CAF50' : '#f44336'};
                                        color: white;
                                        border: none;
                                        padding: 5px 10px;
                                        border-radius: 4px;
                                        margin-right: 5px;
                                        cursor: pointer;
                                    ">
                                        ${enabled ? '禁用' : '启用'}
                                    </button>
                                    <button type="button" onclick="removeSchedule(${index})" style="
                                        background: #ff9800;
                                        color: white;
                                        border: none;
                                        padding: 5px 10px;
                                        border-radius: 4px;
                                        cursor: pointer;
                                    ">
                                        删除
                                    </button>
                                </div>
                            </div>
                            
                            <div class="field-row" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                                <div class="field-group">
                                    <label>名称</label>
                                    <input type="text" 
                                           class="schedule-name" 
                                           value="${escapeHtml(name)}"
                                           placeholder="例如：工作时间">
                                </div>
                                
                                <div class="field-group">
                                    <label>开始时间</label>
                                    <input type="time" 
                                           class="schedule-start" 
                                           value="${startTime}"
                                           step="60">
                                </div>
                                
                                <div class="field-group">
                                    <label>结束时间</label>
                                    <input type="time" 
                                           class="schedule-end" 
                                           value="${endTime}"
                                           step="60">
                                </div>
                                
                                <div class="field-group">
                                    <label>执行操作</label>
                                    <select class="schedule-action">
                    `;
                    
                    actions.forEach(actionItem => {
                        html += `
                            <option value="${actionItem.value}" ${action === actionItem.value ? 'selected' : ''}>
                                ${actionItem.label}
                            </option>
                        `;
                    });
                    
                    html += `
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        提示：如果要配置跨午夜的时间段（如 22:00 到 06:00），结束时间应小于开始时间
                    </div>
                </div>
            `;
                });
            }
            
            html += `
                    </div>
                </div>
            `;
            
            tabContent.innerHTML = html;
        }
        
        // 转义HTML特殊字符
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>'"]/g, function(m) { return map[m]; });
        }
        
        // 显示状态消息
        function showStatus(message, isSuccess) {
            const statusDiv = document.getElementById('status');
            const icon = isSuccess ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-circle"></i>';
            const type = isSuccess ? 'success' : 'error';
            
            statusDiv.innerHTML = `${icon} ${message}`;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'flex';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        // 运行命令
        function runCommand(command) {
            const button = document.querySelector(`.command-btn.${command}`);
            const originalText = button.innerHTML;
            
            // 显示加载状态
            button.classList.add('loading');
            button.disabled = true;
            
            fetch('/command', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({command: command})
            })
            .then(response => response.json())
            .then(data => {
                // 恢复按钮状态
                button.classList.remove('loading');
                button.innerHTML = originalText;
                button.disabled = false;
                
                if (data.success) {
                    showStatus(`命令执行成功: ${command}`, true);
                } else {
                    showStatus(`命令执行失败: ${data.message}`, false);
                }
            })
            .catch(error => {
                // 恢复按钮状态
                button.classList.remove('loading');
                button.innerHTML = originalText;
                button.disabled = false;
                
                showStatus('请求失败: ' + error, false);
            });
        }
        
        // 添加新时间段
        function addNewSchedule() {
            const container = document.getElementById('scheduledActionsContainer');
            const index = document.querySelectorAll('.schedule-item').length;
            
            const newSchedule = `
                <div class="schedule-item" data-index="${index}" style="
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 15px;
                    background: #f8f9fa;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #333;">
                            ✓ 新时间段
                        </h4>
                        <div>
                            <button type="button" onclick="toggleSchedule(${index})" style="
                                background: #4CAF50;
                                color: white;
                                border: none;
                                padding: 5px 10px;
                                border-radius: 4px;
                                margin-right: 5px;
                                cursor: pointer;
                            ">
                                禁用
                            </button>
                            <button type="button" onclick="removeSchedule(${index})" style="
                                background: #ff9800;
                                color: white;
                                border: none;
                                padding: 5px 10px;
                                border-radius: 4px;
                                cursor: pointer;
                            ">
                                删除
                            </button>
                        </div>
                    </div>
                    
                    <div class="field-row" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                        <div class="field-group">
                            <label>名称</label>
                            <input type="text" 
                                   class="schedule-name" 
                                   value="新时间段"
                                   placeholder="例如：工作时间">
                        </div>
                        
                        <div class="field-group">
                            <label>开始时间</label>
                            <input type="time" 
                                   class="schedule-start" 
                                   value="09:00"
                                   step="300">
                        </div>
                        
                        <div class="field-group">
                            <label>结束时间</label>
                            <input type="time" 
                                   class="schedule-end" 
                                   value="17:00"
                                   step="300">
                        </div>
                        
                        <div class="field-group">
                            <label>执行操作</label>
                            <select class="schedule-action">
                                <option value="none">不执行任何操作</option>
                                <option value="logout">注销系统</option>
                                <option value="shutdown" selected>关闭计算机</option>
                                <option value="restart">重新启动</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        提示：如果要配置跨午夜的时间段（如 22:00 到 06:00），结束时间应小于开始时间
                    </div>
                </div>
            `;
            
            if (container.querySelector('.no-schedule')) {
                container.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <button type="button" onclick="addNewSchedule()" class="action-btn save" style="padding: 10px 15px;">
                            <i class="fas fa-plus"></i> 添加新时间段
                        </button>
                    </div>
                    ${newSchedule}
                `;
            } else {
                container.insertAdjacentHTML('beforeend', newSchedule);
            }
        }
        
        // 切换时间段启用/禁用状态
        function toggleSchedule(index) {
            const scheduleItem = document.querySelector(`.schedule-item[data-index="${index}"]`);
            if (!scheduleItem) return;
            
            const title = scheduleItem.querySelector('h4');
            const toggleBtn = scheduleItem.querySelector('button[onclick^="toggleSchedule"]');
            const isEnabled = !title.textContent.includes('✗');
            
            if (isEnabled) {
                title.innerHTML = title.innerHTML.replace('✓', '✗');
                scheduleItem.style.background = '#f0f0f0';
                toggleBtn.textContent = '启用';
                toggleBtn.style.background = '#f44336';
            } else {
                title.innerHTML = title.innerHTML.replace('✗', '✓');
                scheduleItem.style.background = '#f8f9fa';
                toggleBtn.textContent = '禁用';
                toggleBtn.style.background = '#4CAF50';
            }
        }
        
        // 删除时间段
        function removeSchedule(index) {
            const scheduleItem = document.querySelector(`.schedule-item[data-index="${index}"]`);
            if (!scheduleItem) return;
            
            if (confirm('确定要删除这个时间段配置吗？')) {
                scheduleItem.remove();
                
                // 重新索引
                const items = document.querySelectorAll('.schedule-item');
                items.forEach((item, newIndex) => {
                    item.setAttribute('data-index', newIndex);
                    
                    const toggleBtn = item.querySelector('button[onclick^="toggleSchedule"]');
                    const removeBtn = item.querySelector('button[onclick^="removeSchedule"]');
                    
                    toggleBtn.setAttribute('onclick', `toggleSchedule(${newIndex})`);
                    removeBtn.setAttribute('onclick', `removeSchedule(${newIndex})`);
                });
                
                // 如果没有时间段了，显示空状态
                if (items.length === 0) {
                    const container = document.getElementById('scheduledActionsContainer');
                    container.innerHTML = `
                        <div class="no-schedule" style="text-align: center; padding: 20px; color: #666;">
                            <i class="fas fa-clock fa-2x" style="margin-bottom: 10px;"></i>
                            <p>未配置时间段，将使用全局默认操作</p>
                            <button type="button" onclick="addNewSchedule()" class="action-btn save" style="margin-top: 10px;">
                                <i class="fas fa-plus"></i> 添加时间段
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // 表单提交
        document.getElementById('configForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {};
            
            // 收集所有表单数据
            for (let [key, value] of formData.entries()) {
                // 处理嵌套对象
                const keys = key.split('.');
                let current = data;
                
                for (let i = 0; i < keys.length - 1; i++) {
                    if (!current[keys[i]]) {
                        current[keys[i]] = {};
                    }
                    current = current[keys[i]];
                }
                
                current[keys[keys.length - 1]] = value;
            }
            
            // 添加全局默认操作
            const globalAction = document.querySelector('input[name="task_completion_action"]:checked');
            if (globalAction) {
                data.task_completion_action = globalAction.value;
            }
            
            // 收集时间段配置
            const scheduledActions = [];
            const scheduleItems = document.querySelectorAll('.schedule-item');
            
            scheduleItems.forEach((item, index) => {
                const nameInput = item.querySelector('.schedule-name');
                const startInput = item.querySelector('.schedule-start');
                const endInput = item.querySelector('.schedule-end');
                const actionSelect = item.querySelector('.schedule-action');
                const title = item.querySelector('h4');
                
                const isEnabled = !title.textContent.includes('✗');
                
                scheduledActions.push({
                    name: nameInput.value || `时间段${index + 1}`,
                    start_time: startInput.value || '00:00',
                    end_time: endInput.value || '23:59',
                    action: actionSelect.value || 'none',
                    enabled: isEnabled
                });
            });
            
            data.scheduled_completion_actions = scheduledActions;
            
            // 显示保存状态
            const saveBtn = document.querySelector('.action-btn.save');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
            saveBtn.disabled = true;
            
            fetch('/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                // 恢复按钮状态
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                
                if (data.success) {
                    showStatus('配置保存成功！', true);
                    // 重新加载配置
                    fetch('/config')
                        .then(response => response.json())
                        .then(newConfig => {
                            configData = newConfig;
                            // 重新渲染表单以反映保存的数据
                            renderConfigForm();
                        });
                } else {
                    showStatus('保存失败: ' + data.message, false);
                }
            })
            .catch(error => {
                // 恢复按钮状态
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
                
                showStatus('请求失败: ' + error, false);
            });
        });
        
        // 重置表单
        function resetForm() {
            if (confirm('确定要重置表单吗？所有更改将丢失。')) {
                fetch('/config')
                    .then(response => response.json())
                    .then(data => {
                        configData = data;
                        renderConfigForm();
                        showStatus('表单已重置为当前配置', true);
                    })
                    .catch(error => {
                        showStatus('重置失败: ' + error, false);
                    });
            }
        }
    </script>
</body>
</html>